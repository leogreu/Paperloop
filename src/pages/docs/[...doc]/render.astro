---
import "@/styles/globals.css";
import { db, Document, eq } from "astro:db";
import { Button } from "@/components/ui/button";
import { Printer } from "lucide-react";

import Layout from "@/components/custom/layout.astro";
import DocumentRender from "@/components/custom/document-render.astro";
import { defaultLocale, getPreferredLocale, getTranslations } from "@/utils/i18n.ts";

const { doc } = Astro.params;
if (!doc) return;

const values = Object.fromEntries(new URLSearchParams(Astro.url.search));
const entry = await db.select().from(Document).where(eq(Document.id, doc)).get();
if (!entry) return;

const locale = getPreferredLocale(Astro.request.headers) ?? defaultLocale;
const i18n = getTranslations(locale);
---

<Layout title={entry.name} description="Doc">
    <Button id="print" slot="navbar" variant="outline" size="sm">
        <Printer className="mr-2 h-4 w-4" />
        {i18n("print")}
    </Button>
    <div class="mt-12">
        <DocumentRender value={entry.markdown} values={values}></DocumentRender>
    </div>
</Layout>

<script>
    document.addEventListener("astro:page-load", () => {
        document.querySelector("button#print")?.addEventListener("click", () => print());;
    });
</script>

<style>
    @media print {    
        article {
            margin-top: 0;
        }
    }
</style>
