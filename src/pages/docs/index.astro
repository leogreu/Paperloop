---
import "@/styles/globals.css";
import { db, desc, Document } from "astro:db";
import { Card, CardHeader, CardContent, CardFooter } from "@/components/ui/card";

import Layout from "@/components/custom/layout.astro";
import DocumentHeader from "@/components/custom/document-header.astro";
import { getPreferredLocale, getTranslations } from "@/utils/i18n.ts";

const docs = await db.select().from(Document).orderBy(desc(Document.version));
const highesVersions = docs.reduce<typeof docs>((result, doc) => {
    if (!result.some(entry => entry.document === doc.document)) result.push(doc);
    return result;
}, []);

// Used to provide a language-specific meta alternate link for SEO
const locale = Astro.url.searchParams.get("lang") ?? getPreferredLocale(Astro.request.headers);
const i18n = getTranslations(locale);
---

<Layout title={i18n("new-document")} description={i18n("new-document")} locale={locale}>
    <div class="grid grid-cols-3 gap-4">
        {highesVersions.map(doc =>
            <a href={"docs/" + doc.id} transition:name={doc.id}>
                <Card className="flex flex-col h-full cursor-pointer">
                    <CardHeader>
                        <DocumentHeader doc={doc}></DocumentHeader>
                    </CardHeader>
                    <CardContent className="flex-1">
                        <article class="whitespace-pre-line line-clamp-3">
                            {doc.markdown}
                        </article>
                    </CardContent>
                    <CardFooter>
                        <p class="leading-none text-sm text-gray-400">
                            <time datetime={doc.updated.toISOString()}>&nbsp;</time>
                        </p>
                    </CardFooter>
                </Card>
            </a>
        )}
    </div>
</Layout>

<script>
    document.addEventListener("astro:page-load", () => {
        document.querySelectorAll("time").forEach(time => {
            time.textContent = new Date(time.dateTime).toLocaleString(undefined, {
                dateStyle: "medium",
                timeStyle: "short"
            });
        });
    });
</script>
