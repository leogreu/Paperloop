---
import "@/styles/globals.css";
import { db, Document, eq } from "astro:db";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";

import Layout from "@/components/custom/layout.astro";
import { defaultLocale, getPreferredLocale, getTranslations } from "@/utils/i18n.ts";

const { slug } = Astro.params;
if (!slug) return;

const doc = await db.select().from(Document).where(eq(Document.id, slug)).get();
if (!doc) return;

const locale = getPreferredLocale(Astro.request.headers) ?? defaultLocale;
const i18n = getTranslations(locale);
---

<Layout title="Doc" description="Doc" locale={locale}>
    <div class="h-full flex gap-4">
        <div class="h-full flex-1" transition:name={doc.id}>
            <Card className="h-full flex-1 bg-gray-50">
                <CardHeader>
                    <CardTitle>
                        {doc.name}
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <article>{doc.markdown}</article>
                </CardContent>
            </Card>
        </div>
        <Card className="h-full flex-1"></Card>
    </div>
</Layout>

<script>
    import { standardKeymap, historyKeymap, history } from "@codemirror/commands";
    import { EditorView, keymap } from "@codemirror/view";

    const article = document.querySelector("article");
    if (!article) throw new Error();

    const markdown = article.textContent ?? String();
    article.textContent = String();

    new EditorView({
        parent: article,
        doc: markdown,
        extensions: [
            EditorView.lineWrapping,
            keymap.of(standardKeymap),
            keymap.of(historyKeymap),
            history()
        ]
    });
</script>
