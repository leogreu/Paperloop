---
import Particles from './particles.astro';

export interface Props {
    id: string;
    value?: string;
    values?: Record<string, string>;
}
---

<div id="document-wrapper" class="max-w-prose mx-auto" transition:name="render">
    <Particles data={Astro.props}></Particles>
    <article id="document-render" class="prose dark:prose-invert"></article>
</div>

<script>
    import { getParticles } from "@/utils/particles";
    import { markdownToHTML } from "@/utils/markdown";
    import { ContentEditable } from "@/components/custom/content-editable";
    import type { Props } from "./document-render.astro";

    document.addEventListener("astro:page-load", () => {
        const wrapper = document.getElementById("document-wrapper");
        const render = document.getElementById("document-render");
        if (!wrapper || !render) return;

        const { id, value = String(), values = {} } = getParticles<Props>(wrapper);
        render!.innerHTML = markdownToHTML(value, values);

        render.addEventListener("input", ({ target }) => {
            if (target instanceof ContentEditable) {
                const { value, placeholder } = target;
                values[placeholder] = value;
                sessionStorage.setItem(id, JSON.stringify(values));

                // Update inputs sharing the same placeholder (i.e., variable name)
                for (const element of render.querySelectorAll(`[placeholder="${placeholder}"]`)) {
                    if (element !== target) element.setAttribute("value", value);
                }
            }
        });
    });
</script>

<style>
    .prose h1, .prose h2, .prose h3, .prose p {
        margin-top: 0;
    }
</style>
